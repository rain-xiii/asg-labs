## Overview

This guide outlines the process of setting up a hybrid DNS solution using **Route 53 Resolver** and **AWS Managed Microsoft Active Directory**. The setup emulates an on-premises DNS system while leveraging AWS services to enhance security and high availability.

## 1. Using AWS Quick Start

AWS Quick Start is a collection of architectural templates created by AWS Solution Architects and Partners. These templates use **AWS CloudFormation** as the underlying tool for building the infrastructure.

### What is AWS CloudFormation?

AWS CloudFormation is AWS‚Äôs **Infrastructure as Code (IaC)** service. It allows users to create infrastructure from templates written in **YAML** or **JSON**. The template is uploaded to CloudFormation, which automatically provisions the resources as defined in the template.

## 2. Deploying AWS Managed Microsoft Active Directory

AWS Directory Service allows you to deploy **Active Directory** directly on AWS, simplifying management and granting users access to AWS services.

## 3. Deployment Steps

### Step 1: Create a Key-Pair

Before launching the CloudFormation stack, create an **EC2 Key-Pair** to access instances securely.

### Step 2: Deploy the CloudFormation Stack

Since this guide focuses on setting up **Route 53**, we will use the AWS Quick Start template to build the network infrastructure.

1. Navigate to **AWS CloudFormation** and launch the Quick Start template.
2. In the "Specify stack details" step, set **"Allowed Remote Desktop Gateway External Access CIDR"** to `0.0.0.0/0`.
    - **‚ö†Ô∏è Important Security Considerations:**
        - Avoid using `0.0.0.0/0` unless additional security measures like **MFA** or **VPN** are in place.
        - Restrict CIDR to only your **IP address** or your **organization‚Äôs IP range**.
        - Consider using **AWS Systems Manager Session Manager** instead of **RD Gateway** for enhanced security.

![Cloudformation Stack](/Set-up-Hybrid-DNS/screenshots/Cloudformation-stack-created.PNG)

### Step 3: Update Security Groups

1. **Remove Ports 3391 and 443** from the security group.
2. **Update RDP and ICMP rules**:
    - Change the source to **"My IP"** for better security.

üîπ **Why?**

- When enabling **RDP from the internet**, you are directly connecting to the machine without going through **RD Gateway**.
- **Ports 3391 and 443 are not needed** in this case.

üî∏ **Real-world Security Best Practices:**

- **Do not open port 3389** directly to the internet (`0.0.0.0/0`) as it is a major security risk.
- If internet access is required, use **RD Gateway (port 443)** or a **VPN**.
- Alternatively, use **AWS Systems Manager Session Manager** instead of RDP, as it does not require exposing any ports to the internet.

### Step 4: Connect to the RD Gateway Server

Use **Remote Desktop Protocol (RDP)** to access the **Remote Desktop Gateway (RDGW) instance**.

![Connecting to RDGW](/Set-up-Hybrid-DNS/screenshots/Connecting-to-RDGW.png)

## 4. Deploying Microsoft Active Directory

- Use **AWS Directory Service** to deploy **AWS Managed Microsoft Active Directory**.
- Deploy the Active Directory across **two private subnets** to simulate **on-premises DNS**.

![Microsoft AD Created](/Set-up-Hybrid-DNS/screenshots/Microsoft-AD-Created.PNG)
## 5. Configuring Route 53 for DNS Resolution

### Step 1: Create a Route 53 Outbound Endpoint

- AWS will generate an **Elastic Network Interface (ENI)** in each specified **Availability Zone (AZ)**.
- **Why ENI is important?**
    - When creating **Outbound or Inbound Endpoints**, AWS provisions an **ENI in each subnet**.
    - This **ENI has a static IP address** used by Route 53 Resolver to send DNS queries outside the VPC.
    - ENI helps with **routing, security, and high availability (HA)**.
- **Security Group for this Endpoint:** `d-###‚Ä¶.#_controllers` (Automatically generated by CloudFormation for securing connections to AWS Managed Microsoft AD).

![Outbound Endpoint](/Set-up-Hybrid-DNS/screenshots/Outbound-Endpoint-created.PNG)
### Step 2: Configure Route 53 Resolver Rules

- Configure **Route 53 Resolver** to forward queries for `onprem.example.com` to an external **DNS resolver** (e.g., AWS Managed Microsoft AD).
- The domain `onprem.example.com` simulates a DNS domain hosted by an **on-premises DNS system**.

![Forward Rule](/Set-up-Hybrid-DNS/screenshots/Forward-rule-created.PNG)
### Step 3: Create Route 53 Inbound Endpoints

- This allows AWS Managed AD to **forward DNS queries back** to Route 53 Resolver.

### Step 4: Testing

- Verify that Route 53 Resolver correctly forwards **onprem.example.com** queries to AWS Managed Microsoft AD.
![Command Promt Test](/Set-up-Hybrid-DNS/screenshots/Command-Promt-test.png)
- Test connectivity between EC2 instances and the AD domain.
![Power Shell Test](/Set-up-Hybrid-DNS/screenshots/Powershell-test.png)
## Summary

This guide covers how to:

- Use **AWS Quick Start** and **CloudFormation** to set up a **secure, highly available network infrastructure**.
- Deploy **AWS Managed Microsoft Active Directory** to simulate **on-premises DNS**.
- Configure **Route 53 Resolver** to manage DNS queries efficiently.

For real-world deployments, **always follow security best practices** and consider alternatives like **AWS Systems Manager Session Manager** instead of exposing RDP over the internet.

